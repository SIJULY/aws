<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Instance Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-end mb-2">
            <a href="/logout" class="btn btn-outline-danger btn-sm">登出</a>
        </div>
        <header class="text-center mb-4">
            <h1 class="display-5">AWS Instance Web</h1>
            <p class="text-muted">Powered by 小龙女她爸 & 雨后天霁</p>
        </header>

        <div class="card mb-4">
            <div class="card-header">AWS 账户管理</div>
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">添加AWS账户</button>
                    <button id="manageAccountsBtn" class="btn btn-secondary">管理AWS账户</button>
                </div>
                <div id="currentAccountStatus">当前AWS账户: <span class="fw-bold text-danger">未选择</span></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">操作区域</div>
            <div class="card-body">
                <div class="row g-3 align-items-center mb-3">
                    <div class="col-auto"><label for="regionSelector" class="col-form-label">选择区域:</label></div>
                    <div class="col"><select class="form-select" id="regionSelector" disabled><option>请先选择AWS账户</option></select></div>
                    <div class="col-auto"><button id="activateRegionBtn" class="btn btn-warning" disabled>激活此区域</button></div>
                </div>
                <h6>创建实例</h6>
                <div class="btn-group w-100 mb-3">
                    <button id="createEc2Btn" class="btn btn-success" disabled>创建 EC2 实例</button>
                    <button id="createLsBtn" class="btn btn-info" disabled>创建 Lightsail 实例</button>
                </div>
                <div class="mb-3">
                    <label for="rootPassword" class="form-label">Root 密码 (可选, 留空则不设置)</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="rootPassword" placeholder="输入实例的 root 密码" value="You22kme#12345">
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <h6>开机脚本 (User Data)</h6>
                <textarea id="userData" class="form-control" rows="8">#!/bin/bash
# --- 开启 Root 密码登录支持 (针对新版 AMI) ---
sed -i 's/^#?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
systemctl restart sshd || systemctl restart ssh
                    
# 默认脚本: 安装 Xray 套件 &amp; gost SOCKS5 代理

# --- 第一部分: 安装 Xray 套件 ---
(wget -qO- https://raw.githubusercontent.com/SIJULY/xray/main/vless.sh | sed 's/\r//' | bash && \
wget -qO- https://raw.githubusercontent.com/SIJULY/xray/main/vmess.sh | sed 's/\r//' | bash && \
wget -qO- https://raw.githubusercontent.com/SIJULY/xray/main/Shadowsocks.sh | bash && \
wget -qO- https://raw.githubusercontent.com/SIJULY/xray/main/ss5.sh | bash) > /root/install.log 2>&1 && \

# --- 第二部分: 安装并运行 gost SOCKS5 代理 ---
(wget -qO- https://github.com/ginuerzh/gost/releases/download/v2.12.0/gost_2.12.0_linux_amd64.tar.gz \
| tar -zxv gost && chmod +x ./gost && \
nohup ./gost -L=socks5://:8896?dns=https://doh.opendns.com/dns-query > /root/gost.log 2>&1 &)
</textarea>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>实例信息</span>
                <div class="btn-group">
                    <button id="querySelectedRegionBtn" class="btn btn-sm btn-outline-primary" disabled>查询选中区域</button>
                    <button id="queryAllRegionsBtn" class="btn btn-sm btn-outline-secondary" disabled>查询所有区域</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>类型</th>
                                <th>区域</th>
                                <th>名称/ID</th>
                                <th>状态</th>
                                <th>公网IP</th>
                                <th class="text-center" style="position: relative; left: -15px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="instanceList">
                            <tr><td colspan="6" class="text-center text-muted">请先查询实例</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between">
                日志输出
                <button id="clearLogBtn" class="btn btn-sm btn-outline-danger">清除日志</button>
            </div>
            <div class="card-body p-2">
                <pre id="logOutput" class="form-control mb-0" style="height: 200px;"></pre>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addAccountModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">添加新账户</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addAccountForm"><div class="mb-3"><label for="accountName" class="form-label">账户名称</label><input type="text" class="form-control" id="accountName" required></div><div class="mb-3"><label for="accessKey" class="form-label">Access Key ID</label><input type="text" class="form-control" id="accessKey" required></div><div class="mb-3"><label for="secretKey" class="form-label">Secret Access Key</label><input type="password" class="form-control" id="secretKey" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" id="saveAccountBtn" class="btn btn-primary">保存</button></div></div></div>
    </div>
    <div class="modal fade" id="manageAccountsModal" tabindex="-1">
         <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">管理AWS账户</h5>
                    <button id="queryAllQuotasBtn" class="btn btn-sm btn-primary ms-auto">一键查询所有配额</button>
                    <button type="button" class="btn-close ms-2" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>账户名称</th>
                                <th style="position: relative; left: -15px;">vCPU配额</th>
                                <th class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="accountList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ec2TypeModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">选择 EC2 实例类型</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="ec2Spinner" class="text-center" style="display: none;"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div><select id="ec2TypeSelector" class="form-select"></select></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" id="confirmEc2CreationBtn" class="btn btn-primary">确认开启</button></div></div></div>
    </div>
    <div class="modal fade" id="lightsailTypeModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">选择 Lightsail 实例类型</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="lightsailSpinner" class="text-center" style="display: none;"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div><select id="lightsailTypeSelector" class="form-select"></select></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button type="button" id="confirmLightsailCreationBtn" class="btn btn-primary">确认开启</button></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
